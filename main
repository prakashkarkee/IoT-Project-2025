from machine import Pin, I2C
import network
import time
#Secure MQTT TLS connection
import ssl
#MQTTClient is used to publish data using the MQTT protocol
from umqtt.robust import MQTTClient
from bmp280 import BMP280

#network access credentials
WIFI_SSID = "abcnet"
WIFI_PASS = "Chandi@123"

#HiveMQ Cloud Configuration
##MQTT_HOST = "xxxxxxxxxxxxxxx.s1.eu.hivemq.cloud"
MQTT_PORT = 8883
##MQTT_USER = "xxxxxxxx"
##MQTT_PASS = "xxxxxxxxxxxx"
MQTT_CLIENT_ID = b"Measurement_Device"

#publishing and subscribing MQTT topic
TOPIC_CELSIUS = b"Measurement_Device/celsius"

#I2C + BMP280
i2c = I2C(0, sda=Pin(4), scl=Pin(5), freq=400000)
bmp = BMP280(i2c)

#wifi connection and status
def wifi_connect():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)

    if not wlan.isconnected():
        wlan.connect(WIFI_SSID, WIFI_PASS)
        print("Connecting to WiFi...")
        while not wlan.isconnected():
            time.sleep(1)

    print("WiFi connected:", wlan.ifconfig())
    return wlan

#MQTT connection
def mqtt_connect():
    ctx = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)
    ctx.verify_mode = ssl.CERT_NONE  

    client = MQTTClient(
        client_id=MQTT_CLIENT_ID,
        server=MQTT_HOST,
        port=MQTT_PORT,
        user=MQTT_USER,
        password=MQTT_PASS,
        ssl=ctx,
        keepalive=60
    )

    client.connect()
    print("MQTT connected")
    return client

#connecting to wifi
wifi_connect()
client = mqtt_connect()

#main loop for sensor read and MQTT publishing
while True:
    try:
        temperature = bmp.temperature
        print("Temperature:", temperature)

        client.publish(TOPIC_CELSIUS, str(temperature))
        print("Published to MQTT")

        time.sleep(10)  

    except Exception as e:
        print("Error:", e)
        time.sleep(5)
