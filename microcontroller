IoT Project 2025

from bmp280 import bmp280
from machine import Pin, I2C
import utime
import network
from umqtt.robust import MQTTClient
import ssl

# Setting up the I2C sda and scl pins and sensor object.
i2c1_sda = Pin(4) # Same channel c1.
i2c1_scl = Pin(5) # Same channel c1.
sensor_object = BMP280.I2C(1, sda = i2c1_sda, scl = i2c1_scl) # Channel c1, sda and scl pins.

# WiFi connection configuration.
wifi = network.WLAN()
wifi.active(True)
wifi.connect("test1", "password1")

# Connecting to the WiFi with timer variable that iterates till the condition is met. 
# Only automatic break from the loop is with a successful connection. 
# Printing response to each state.
wifi_timer = 0 # Changed timer variable.
if wifi_timer < 7: # Attempts till completion.
    if wlan.status() == 3:# Connection has been established. CYW43_LINK_UP.
        print("Connection has been established.")
        status = wifi.ifconfig() # Saving the IP address.
        print(f"IP = {status[0]}")
    elif wlan.status() == 2:# Connection is being formed. CYW43_LINK_NOIP.
        print("Connecting, but waiting for IP address.")
    elif wlan.status() == 1: # Connecting but not authenticated. CYW43_LINK_JOIN.
        print("Connecting, but waiting for authentication.")
    elif wlan.status() == 0: # Data flow is halted but WiFi exists. CYW43_LINK_DOWN.
        print("WiFi exists but not active.")
    elif wlan.status() == -1: # Connection issue. CYW43_LINK_FAIL.
        print("Connection error.")
    elif wlan.status() == -2: # No network found. CYW43_LINK_NONET.
        print("Network cannot be found.")
    elif wlan.status() == -3: # Wrong password. CYW43_LINKBADAUTH.
        print("Password error.")
    else:
        print("Wrong format.")
    wifi_timer = wifi_timer + 1 # Incrementing timer variable.
    utime.sleep_ms(10000) # Time frame till next loop.

# Sensor data reading and publishing MQTT loop. "State" change through built logic.
State = 0
if State != 1:
    celsius = sensor_object.temperature # Sensor data reading into celsius variable.
    publish(celsius_topic, f"{celsius}") # Sensor data publishing to Node-Red.
    utime.sleep_ms(900000) # 15 minutes till next loop. 

# HiveMQ connection function.
def hivemq_connection():
    ssl_optional = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)
    ssl_optional.verify_mode = ssl.CERT_OPTIONAL
    hivemq_client_connection = MQTTClient(client_id = b"Measurement_Device", server = "d298d263547e404db3f50ce233c41f8f.s1.eu.hivemq.cloud:8883", keepalive = 18000 port = 8883, user = b"IoTProject2025", password = b"Y[Ob05r-@Yta", ssl = ssl_optional, reconn = True, version = 4)
    hivemq_client_connection.connect()

# Node-Red
celsius_topic = b"Measurement_Device/celsius"
